# ============================================================
# Docker Compose — оркестрация многоконтейнерного приложения
# ============================================================
# Версия синтаксиса Docker Compose
# 3.8 поддерживает все современные возможности
version: "3.8"

# ============================================================
# Определение сервисов (контейнеров)
# ============================================================
services:

  # ==========================================================
  # Сервис web — Python FastAPI приложение
  # ==========================================================
  web:
    # Сборка образа из Dockerfile
    build:
      # Контекст сборки — директория с Dockerfile и исходным кодом
      context: ./app
      # Путь к Dockerfile относительно контекста
      dockerfile: Dockerfile

    # Имя контейнера (опционально, но удобно для отладки)
    container_name: watermark-api

    # Политика перезапуска контейнера
    # always — перезапускать всегда (при падении, перезагрузке хоста и т.д.)
    restart: always

    # Порты НЕ пробрасываем наружу напрямую!
    # Доступ к API только через Nginx (security best practice)
    # expose только делает порт доступным для других контейнеров
    expose:
      - "8000"

    # Сети, к которым подключён контейнер
    networks:
      - app-network

  # ==========================================================
  # Сервис nginx — Reverse Proxy сервер
  # ==========================================================
  nginx:
    # Используем официальный образ Nginx последней версии
    image: nginx:latest

    # Имя контейнера
    container_name: watermark-nginx

    # Политика перезапуска
    restart: always

    # Проброс портов: внешний_порт:внутренний_порт
    # 80:80 — HTTP трафик с хоста направляется в контейнер
    ports:
      - "80:80"

    # Монтирование томов (volumes)
    volumes:
      # Пробрасываем конфигурационный файл Nginx внутрь контейнера
      # :ro (read-only) — контейнер не может изменять этот файл
      # Левая часть — путь на хосте
      # Правая часть — путь внутри контейнера
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro

    # Зависимость от другого сервиса
    # Nginx запустится ПОСЛЕ того, как web-сервис будет запущен
    # Это важно, т.к. Nginx должен проксировать на работающий backend
    depends_on:
      - web

    # Сети, к которым подключён контейнер
    networks:
      - app-network

# ============================================================
# Определение сетей
# ============================================================
networks:
  # Создаём изолированную сеть для наших сервисов
  # Контейнеры в этой сети могут обращаться друг к другу по имени сервиса
  app-network:
    # bridge — стандартный драйвер для изолированной сети
    driver: bridge

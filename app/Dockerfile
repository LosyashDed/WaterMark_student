# ============================================================
# Dockerfile для Python-сервиса обработки изображений
# ============================================================

# Базовый образ: Python 3.9 на основе Debian slim
# slim-версия занимает меньше места, но содержит все необходимое
FROM python:3.9-slim

# Метаданные образа (опционально, но полезно для документации)
LABEL maintainer="student@university.edu"
LABEL description="Сервис добавления водяных знаков на изображения"

# Устанавливаем рабочую директорию внутри контейнера
# Все последующие команды будут выполняться из этой директории
WORKDIR /app

# Копируем ТОЛЬКО файл зависимостей первым
# Это позволяет Docker кэшировать слой с установленными пакетами
# При изменении кода, но не зависимостей, этот слой берётся из кэша
COPY requirements.txt .

# Устанавливаем системные зависимости
# fonts-dejavu — шрифты для отрисовки водяных знаков
# ВАЖНО: без этого пакета Pillow использует крошечный встроенный шрифт!
RUN apt-get update && \
    apt-get install -y --no-install-recommends fonts-dejavu && \
    rm -rf /var/lib/apt/lists/*

# Устанавливаем Python-зависимости
# --no-cache-dir — не сохранять кэш pip (экономит место в образе)
# --upgrade pip — обновляем pip до последней версии
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# Копируем исходный код приложения в контейнер
# Этот слой пересобирается при каждом изменении кода
COPY . .

# Указываем порт, который будет слушать приложение
# Это документация для пользователей образа (не открывает порт автоматически)
EXPOSE 8000

# Команда запуска приложения
# uvicorn — ASGI-сервер для FastAPI
# main:app — модуль main.py, объект app
# --host 0.0.0.0 — слушать на всех сетевых интерфейсах (важно для Docker!)
# --port 8000 — порт приложения
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]

# ============================================================
# Конфигурация Nginx — Reverse Proxy для FastAPI сервиса
# ============================================================

# Количество рабочих процессов Nginx
# auto — автоматически определяется по количеству ядер CPU
worker_processes auto;

# Настройки обработки событий (соединений)
events {
    # Максимальное количество одновременных соединений на один worker
    # 1024 — стандартное значение для небольших проектов
    worker_connections 1024;
}

# Блок настроек HTTP-сервера
http {

    # ========================================================
    # Блок upstream — определяет группу backend-серверов
    # ========================================================
    # Имя "backend" используется в директиве proxy_pass
    # web:8000 — имя сервиса из docker-compose (Docker DNS) и порт
    upstream backend {
        # Указываем адрес FastAPI сервиса
        # "web" — имя сервиса в docker-compose.yml
        # 8000 — порт, на котором работает uvicorn
        server web:8000;
    }

    # ========================================================
    # Блок server — настройки виртуального сервера
    # ========================================================
    server {
        # Порт, на котором Nginx принимает входящие соединения
        listen 80;

        # Имя сервера (hostname)
        # localhost подходит для локальной разработки
        # В продакшене здесь указывается доменное имя
        server_name localhost;

        # ====================================================
        # Ограничение размера загружаемых файлов
        # ====================================================
        # ВАЖНО для сервиса обработки изображений!
        # 10M — максимальный размер тела запроса (10 мегабайт)
        # При превышении клиент получит ошибку 413 (Request Entity Too Large)
        client_max_body_size 10M;

        # ====================================================
        # Основной location — обрабатывает все запросы
        # ====================================================
        location / {
            # Проксирование запросов на upstream backend
            # Nginx перенаправляет все запросы к FastAPI сервису
            proxy_pass http://backend;

            # ================================================
            # Проброс заголовков — важно для корректной работы
            # ================================================
            
            # Передаём оригинальный Host заголовок от клиента
            # Необходимо для корректной генерации URL в приложении
            proxy_set_header Host $host;

            # Передаём реальный IP-адрес клиента
            # $remote_addr — IP клиента, подключившегося к Nginx
            proxy_set_header X-Real-IP $remote_addr;

            # Передаём цепочку прокси-серверов
            # Если запрос прошёл через несколько прокси, сохраняем всю цепочку
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # Передаём протокол (http или https)
            # Важно, если Nginx терминирует SSL
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
